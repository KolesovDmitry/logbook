<!DOCTYPE html>
<html lang="ru">
<head>
        <meta charset="utf-8" />
        <title>Предобработка данных Sentinel-2 в Google EarthEngine</title>
        <link rel="stylesheet" href="https://kolesovdmitry.github.io/logbook/theme/css/main.css" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://kolesovdmitry.github.io/logbook/">Список всего </a></h1>
                <nav><ul>
                    <li><a href="https://kolesovdmitry.github.io/logbook/category/change-detection.html">Change Detection</a></li>
                    <li class="active"><a href="https://kolesovdmitry.github.io/logbook/category/google-earthengine-tools.html">Google EarthEngine tools</a></li>
                    <li><a href="https://kolesovdmitry.github.io/logbook/category/neuralnets.html">NeuralNets</a></li>
                    <li><a href="https://kolesovdmitry.github.io/logbook/category/raster-processing.html">Raster Processing</a></li>
                    <li><a href="https://kolesovdmitry.github.io/logbook/category/review.html">Review</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://kolesovdmitry.github.io/logbook/predobrabotka-dannykh-sentinel-2-v-google-earthengine.html" rel="bookmark"
           title="Permalink to Предобработка данных Sentinel-2 в Google EarthEngine">Предобработка данных Sentinel-2 в Google EarthEngine</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2019-12-13T00:00:00+03:00">
                Published: Пт 13 декабря 2019
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://kolesovdmitry.github.io/logbook/author/dmitry-kolesov.html">Dmitry Kolesov</a>
        </address>
<p>In <a href="https://kolesovdmitry.github.io/logbook/category/google-earthengine-tools.html">Google EarthEngine tools</a>.</p>
<p>tags: <a href="https://kolesovdmitry.github.io/logbook/tag/sentinel-2.html">Sentinel-2</a> <a href="https://kolesovdmitry.github.io/logbook/tag/remote-sensing.html">Remote Sensing</a> <a href="https://kolesovdmitry.github.io/logbook/tag/gee.html">GEE</a> </p>
</footer><!-- /.post-info -->      <h1>Задача</h1>
<p>Есть большая задача -- построение маски водных объектов по данным ДЗЗ, точнее Sentinel-2. Эта задача разбивается
на множество отдельных подзадач, в частности сейчас решаем вопрос о сборе обучающих данных для алгоритмов маскирования.</p>
<p>Для решения этой частной задачи нужно собрать данные Sentinel-2 на интересующую нас территорию и:</p>
<ul>
<li>удалить с них облака (возможно, и другие шумы);</li>
<li>сделать временнУю аггрегацию по каждому каналу за определенный период времени (или несколько периодов);</li>
<li>подключить дополнительные данные (например, по рельефу), если они нужны.</li>
</ul>
<p>Основная задача -- максимально быстро получить первый вариант классификатора, чтобы затем, пользуясь его результатами
начинать собирать обучающие данные и дополнять их.</p>
<h1>Ход работ</h1>
<h2>1. Обучающие данные в первом приближении.</h2>
<p>В первом приближении водные объекты можно взять в OSM. Они не полные, местами не совпадают с реальными положениями рек (особенно мелких) на снимках, но это очень хороший старт.</p>
<p>Таким образом были импортированы из ОСМ данные по:</p>
<ul>
<li>прибрежная зона;</li>
<li>площадные объекты внутри суши (озера, крупные реки);</li>
<li>линейные объекты.</li>
</ul>
<h2>2. Предобработка снимков</h2>
<p>Предобработка укладывается в несколько строчек кода в Google EarthEngine. Фильтрацию облачности оставимна откуп каналу QA, который содержит бинарные маски облачности. Функция  filterCloudSentinel2 анализирует этот канал и маскирует пиксель, если он был помечен облачным в QA. Далее происходит выбрка снимков по датам и географическому охвату.</p>
<p>Для выбранных снимков производится маскирование облачности и рассчет медианы. Это позволяет по-быстрому избавиться от случайшных флуктуаций в данных получить более устойчивое к шумам изображение. И, наконец, строятся три индекса NDVI, NDWI1 и NDWI2. Первый индекс классический, предназначенный для анализа растительности, а второй и третий -- для анализа воды в листьях и грунте. Думаю, что добавление таких индексов в анализируемый стек каналов может увеличить точность работы (но это не точно )) -- проверим на следующем этапе).</p>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">waterPoly</span> <span class="o">=</span> <span class="nx">ee</span><span class="p">.</span><span class="nx">FeatureCollection</span><span class="p">(</span><span class="s2">&quot;users/.../waterPolyPrim&quot;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">filterCloudSentinel2</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">img</span><span class="p">)</span> <span class="p">{</span>
  <span class="cm">/*</span>
<span class="cm">  Bitmask for QA60</span>

<span class="cm">    Bit 10: Opaque clouds</span>
<span class="cm">        0: No opaque clouds</span>
<span class="cm">        1: Opaque clouds present</span>
<span class="cm">    Bit 11: Cirrus clouds</span>
<span class="cm">        0: No cirrus clouds</span>
<span class="cm">        1: Cirrus clouds present</span>
<span class="cm">  */</span>

  <span class="kd">var</span> <span class="nx">quality</span> <span class="o">=</span> <span class="nx">img</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;QA60&#39;</span><span class="p">).</span><span class="kr">int</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">cloudBit</span> <span class="o">=</span> <span class="nx">ee</span><span class="p">.</span><span class="nb">Number</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>    <span class="c1">// ee.Number(2).pow(10);</span>
  <span class="kd">var</span> <span class="nx">cirrusBit</span> <span class="o">=</span> <span class="nx">ee</span><span class="p">.</span><span class="nb">Number</span><span class="p">(</span><span class="mi">2048</span><span class="p">);</span>   <span class="c1">// ee.Number(2).pow(11);</span>

  <span class="kd">var</span> <span class="nx">cloudFree</span> <span class="o">=</span> <span class="nx">quality</span><span class="p">.</span><span class="nx">bitwiseAnd</span><span class="p">(</span><span class="nx">cloudBit</span><span class="p">).</span><span class="nx">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">cirrusFree</span> <span class="o">=</span> <span class="nx">quality</span><span class="p">.</span><span class="nx">bitwiseAnd</span><span class="p">(</span><span class="nx">cirrusBit</span><span class="p">).</span><span class="nx">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">clear</span> <span class="o">=</span> <span class="nx">cloudFree</span><span class="p">.</span><span class="nx">bitwiseAnd</span><span class="p">(</span><span class="nx">cirrusFree</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">img</span><span class="p">.</span><span class="nx">updateMask</span><span class="p">(</span><span class="nx">clear</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">ee</span><span class="p">.</span><span class="nx">ImageCollection</span><span class="p">(</span><span class="nx">useCollection</span><span class="p">);</span>
<span class="nx">collection</span> <span class="o">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">ee</span><span class="p">.</span><span class="nx">Filter</span><span class="p">.</span><span class="nx">date</span><span class="p">(</span><span class="s1">&#39;2019-04-25&#39;</span><span class="p">,</span> <span class="s1">&#39;2019-11-01&#39;</span><span class="p">));</span>
<span class="nx">collection</span> <span class="o">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">filterBounds</span><span class="p">(</span><span class="nx">waterPoly</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">cloudFree</span> <span class="o">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">filterCloudSentinel2</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">median</span> <span class="o">=</span> <span class="nx">cloudFree</span><span class="p">.</span><span class="nx">median</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">expression</span><span class="p">(</span><span class="s1">&#39;b(&quot;B12&quot;,&quot;B11&quot;, &quot;B8A&quot;,&quot;B4&quot;,&quot;B3&quot;,&quot;B2&quot;)&#39;</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">rename</span><span class="p">(</span><span class="s1">&#39;swir2&#39;</span><span class="p">,</span><span class="s1">&#39;swir1&#39;</span><span class="p">,</span><span class="s1">&#39;nir&#39;</span><span class="p">,</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="s1">&#39;blue&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">NDWI1</span> <span class="o">=</span> <span class="nx">median</span><span class="p">.</span><span class="nx">normalizedDifference</span><span class="p">([</span><span class="s1">&#39;nir&#39;</span><span class="p">,</span> <span class="s1">&#39;swir1&#39;</span><span class="p">]).</span><span class="nx">multiply</span><span class="p">(</span><span class="mi">10000</span><span class="p">).</span><span class="nx">int16</span><span class="p">().</span><span class="nx">rename</span><span class="p">(</span><span class="s1">&#39;NDWI1&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">NDWI2</span> <span class="o">=</span> <span class="nx">median</span><span class="p">.</span><span class="nx">normalizedDifference</span><span class="p">([</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;nir&#39;</span><span class="p">]).</span><span class="nx">multiply</span><span class="p">(</span><span class="mi">10000</span><span class="p">).</span><span class="nx">int16</span><span class="p">().</span><span class="nx">rename</span><span class="p">(</span><span class="s1">&#39;NDWI2&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">NDVI</span> <span class="o">=</span> <span class="nx">median</span><span class="p">.</span><span class="nx">normalizedDifference</span><span class="p">([</span><span class="s1">&#39;nir&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">]).</span><span class="nx">multiply</span><span class="p">(</span><span class="mi">10000</span><span class="p">).</span><span class="nx">int16</span><span class="p">().</span><span class="nx">rename</span><span class="p">(</span><span class="s1">&#39;NDVI&#39;</span><span class="p">);</span>
</pre></div>


<h1>Что получается</h1>
<p>Ниже представлен пример снимка высокого разрешения на данную территорию (можно посмотреть его в полном разрешении):
<img alt="Пример местности" src="images/2019-12-13/highRes.png" title="Пример местности на высоком разрешении" width="90%"></p>
<p>На снимке хорошо видны реки, озера а также меандры в восточной части фрагмента.</p>
<p>На следующем снимке на него наложены данные по водным объектам, полученные из OSM. Видно, что не все водные объекты на снимке покрыты (особенно это относится к меандрам Уссури), есть ошибки в позиционировании небольших рек (возможно, русло поменялось?).</p>
<p><img alt="Пример местности" src="images/2019-12-13/highRes_osm.png" title="Пример местности на высоком разрешении" width="90%"></p>
<p>Далее представлены снимки Sentinel-2 и рассчитанные индексы:</p>
<table>
<thead>
<tr>
<th></th>
<th>Снимок</th>
</tr>
</thead>
<tbody>
<tr>
<td>(swir1, nir, red)</td>
<td><img alt="Пример местности" src="images/2019-12-13/RGB.png" title="RGB Sentinel-2" width="100%"></td>
</tr>
<tr>
<td>NDVI</td>
<td><img alt="Пример местности" src="images/2019-12-13/NDVI.png" title="NDVI" width="100%"></td>
</tr>
<tr>
<td>NDWI1</td>
<td><img alt="Пример местности" src="images/2019-12-13/NDWI1.png" title="NDWI1" width="100%"></td>
</tr>
<tr>
<td>NDWI2</td>
<td><img alt="Пример местности" src="images/2019-12-13/NDWI2.png" title="NDWI2" width="100%"></td>
</tr>
</tbody>
</table>
<p>Вода везде хорошо "вылезла" кроме NDWI1: видно, что в западной части фрагмента все пересвечено. Похоже, там очень влажные леса, которые дают такой эффект. Видно также, если посмотреть снимки в исходном рарзрешении, что Sentinel-2 может оказаться недостаточным, чтобы уверенно отбить мелкие реки и ручьи, хотя они и просматриваются на снимках. Но в целом видно, что вода должна неплохо отделяется от остальных объектво.</p>
<h1>Что дальше</h1>
<p>Следующий шаг -- сбор статистики и посроение первой версии классификатора. Далее будет видно по результатам.</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>