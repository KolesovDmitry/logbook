<!DOCTYPE html>
<html lang="ru">
<head>
        <meta charset="utf-8" />
        <title>Создание обучающих данных в GEE для классификации внешними ресурсами</title>
        <link rel="stylesheet" href="https://kolesovdmitry.github.io/logbook/theme/css/main.css" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://kolesovdmitry.github.io/logbook/">Список всего </a></h1>
                <nav><ul>
                    <li class="active"><a href="https://kolesovdmitry.github.io/logbook/category/google-earthengine-tools.html">Google EarthEngine tools</a></li>
                    <li><a href="https://kolesovdmitry.github.io/logbook/category/review.html">Review</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://kolesovdmitry.github.io/logbook/sozdanie-obuchaiushchikh-dannykh-v-gee-dlia-klassifikatsii-vneshnimi-resursami.html" rel="bookmark"
           title="Permalink to Создание обучающих данных в GEE для классификации внешними ресурсами">Создание обучающих данных в GEE для классификации внешними ресурсами</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2020-01-10T00:00:00+03:00">
                Published: Пт 10 января 2020
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://kolesovdmitry.github.io/logbook/author/dmitry-kolesov.html">Dmitry Kolesov</a>
        </address>
<p>In <a href="https://kolesovdmitry.github.io/logbook/category/google-earthengine-tools.html">Google EarthEngine tools</a>.</p>
<p>tags: <a href="https://kolesovdmitry.github.io/logbook/tag/remote-sensing.html">Remote Sensing</a> <a href="https://kolesovdmitry.github.io/logbook/tag/gee.html">GEE</a> </p>
</footer><!-- /.post-info -->      <p>Периодически возникает необходимость создать обучающее множество примеров на базе данных,
подготовленных к анализу в GEE.</p>
<h1>Попиксельный анализ</h1>
<p>Если планируется попиксельный анализ, то обычно все довольно просто,
нужно подготовить к анализу снимки (<a href="https://kolesovdmitry.github.io/logbook/predobrabotka-dannykh-sentinel-2-v-google-earthengine.html">см., скажем, этот пример</a>),
а затем сгенерировать набор точек и прочитать под этими точками значения яркостей каналов полученных снимков.</p>
<p>Полученную выборку затем можно экспортировать на диск (для попиксельного анализа удобно это делать в формате CSV),
на практике весь прооцесс выглядит  как-то так:</p>
<div class="highlight"><pre><span></span><span class="c1">// data -- интересующий нас растр</span>
<span class="c1">// waterPoly -- полигоны, в которых закодированы классы объектов</span>
<span class="c1">// properties -- список полей, которые интересно сохранить в выборке</span>
<span class="kd">var</span> <span class="nx">points</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sampleRegions</span><span class="p">({</span>
  <span class="nx">collection</span><span class="o">:</span> <span class="nx">waterPoly</span><span class="p">,</span>
  <span class="nx">properties</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span><span class="s1">&#39;G1WBM&#39;</span><span class="p">,</span><span class="s1">&#39;VEGTYPE&#39;</span><span class="p">],</span>
  <span class="nx">scale</span><span class="o">:</span> <span class="mi">15</span><span class="p">,</span>
  <span class="nx">tileScale</span><span class="o">:</span> <span class="mi">1</span>
<span class="p">});</span>

<span class="nx">Export</span><span class="p">.</span><span class="nx">table</span><span class="p">.</span><span class="nx">toDrive</span><span class="p">({</span>
  <span class="nx">collection</span><span class="o">:</span> <span class="nx">points</span><span class="p">,</span>
  <span class="nx">description</span><span class="o">:</span><span class="s1">&#39;Points_sample&#39;</span><span class="p">,</span>
  <span class="nx">folder</span><span class="o">:</span> <span class="s1">&#39;EE&#39;</span><span class="p">,</span>
  <span class="nx">fileFormat</span><span class="o">:</span> <span class="s1">&#39;CSV&#39;</span>
<span class="p">});</span>
</pre></div>


<p>На выходе получится файл CSV примерно такого вида:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;</span>  <span class="n">head</span> <span class="o">-</span><span class="mi">3</span> <span class="n">Points_sample</span><span class="p">.</span><span class="n">csv</span> <span class="o">|</span> <span class="n">cut</span> <span class="o">-</span><span class="n">d</span><span class="p">,</span> <span class="o">-</span><span class="n">f1</span><span class="o">-</span><span class="mi">6</span>

<span class="k">system</span><span class="p">:</span><span class="k">index</span><span class="p">,</span><span class="n">G1WBM</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">VEGTYPE</span><span class="p">,</span><span class="n">green</span><span class="p">,</span><span class="n">green_1</span>
<span class="mi">00000000000000000024</span><span class="n">_0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">38</span><span class="p">,</span><span class="n">shadow</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">0599</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">0732</span>
<span class="mi">00000000000000000024</span><span class="n">_1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">38</span><span class="p">,</span><span class="n">shadow</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">0599</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">0748</span>
</pre></div>


<p>где G1WBM, ID, VEGTYPE -- поля исходных полигональных объектов, а green, green_1,... -- яркости пикселей соответствующих каналов снимка
(в данном примере в снимке было собрано несколько зеленых каналов).</p>
<h1>Пообъектный анализ</h1>
<p>В случае, когда планируется не попиксельный, а пообъектный анализ, предыдущий подход не годится из-за того,
что теряется информация о соседстве. Для пообъектного анализа требуется нарезать снимки и обучающие полигоны на
небольшие тайлы, а затем экспортировать их.</p>
<p>GEE предоставляет возможность экспорта данных в формате TFRecord, что удобно, если планируется дальнейшее
построение классификатора в TensorFlow.</p>
<div class="highlight"><pre><span></span><span class="c1">// Глобальная переменная для no-data</span>
<span class="kd">var</span> <span class="nx">MASK_VALUE</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span><span class="p">;</span>

<span class="c1">// Растеризуем полигоны для растра контуров объектов</span>
<span class="kd">var</span> <span class="nx">waterImage</span> <span class="o">=</span> <span class="nx">waterPoly</span><span class="p">.</span><span class="nx">reduceToImage</span><span class="p">({</span>
    <span class="nx">properties</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;G1WBM&#39;</span><span class="p">],</span>
    <span class="nx">reducer</span><span class="o">:</span> <span class="nx">ee</span><span class="p">.</span><span class="nx">Reducer</span><span class="p">.</span><span class="nx">first</span><span class="p">()</span>
<span class="p">}).</span><span class="nx">unmask</span><span class="p">(</span><span class="nx">MASK_VALUE</span><span class="p">).</span><span class="nx">rename</span><span class="p">(</span><span class="s1">&#39;CLASS&#39;</span><span class="p">);</span>

<span class="c1">// Добавим растр известных объектов к нашему входному изображению</span>
<span class="c1">// composite -- интересующее нас изображение</span>
<span class="c1">// Добавление растра waterImage позволит встроить контуры ответов</span>
<span class="c1">// отдельным каналом рядом с каналами входных данных</span>
<span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">ee</span><span class="p">.</span><span class="nx">Image</span><span class="p">([</span>
  <span class="nx">waterImage</span><span class="p">,</span> <span class="nx">composite</span>
<span class="p">]);</span>

<span class="kd">var</span> <span class="nx">PIXELS</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>  <span class="c1">// Сторона скользящего окна,</span>
                 <span class="c1">// получаем тайл в 19x19 пикселей</span>

<span class="c1">// Делаем выборку тайлов</span>
<span class="kd">var</span> <span class="nx">withNeighborhood</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">neighborhoodToArray</span><span class="p">({</span>
    <span class="nx">kernel</span><span class="o">:</span> <span class="nx">ee</span><span class="p">.</span><span class="nx">Kernel</span><span class="p">.</span><span class="nx">rectangle</span><span class="p">(</span><span class="nx">PIXELS</span><span class="p">,</span> <span class="nx">PIXELS</span><span class="p">,</span> <span class="s1">&#39;pixels&#39;</span><span class="p">),</span>
    <span class="nx">defaultValue</span><span class="o">:</span> <span class="nx">MASK_VALUE</span>
  <span class="p">});</span>
<span class="kd">var</span> <span class="nx">sampleTraining</span> <span class="o">=</span> <span class="nx">withNeighborhood</span><span class="p">.</span><span class="nx">sampleRegions</span><span class="p">({</span>
    <span class="nx">collection</span><span class="o">:</span> <span class="nx">waterPoly</span><span class="p">,</span>
    <span class="nx">scale</span><span class="o">:</span> <span class="nx">consts</span><span class="p">.</span><span class="nx">SCALE</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
    <span class="nx">projection</span><span class="o">:</span> <span class="nx">ee</span><span class="p">.</span><span class="nx">Projection</span><span class="p">(</span><span class="s1">&#39;EPSG:3857&#39;</span><span class="p">),</span>
    <span class="nx">tileScale</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">});</span>

<span class="c1">// Если объемы большие, лучше экспортировать не</span>
<span class="c1">// на диск,</span>
<span class="nx">Export</span><span class="p">.</span><span class="nx">table</span><span class="p">.</span><span class="nx">toCloudStorage</span><span class="p">({</span>
  <span class="nx">collection</span><span class="o">:</span> <span class="nx">sampleTraining</span><span class="p">,</span>
  <span class="nx">bucket</span><span class="o">:</span> <span class="s1">&#39;klsvd_gee&#39;</span><span class="p">,</span>
  <span class="nx">fileFormat</span><span class="o">:</span> <span class="s1">&#39;TFRecord&#39;</span><span class="p">,</span>
  <span class="nx">description</span><span class="o">:</span> <span class="s1">&#39;WaterClasses&#39;</span>
<span class="p">});</span>
</pre></div>


<p>В итоге будет получен набор данных (тайлы изображения) в формате TFRecord, который можно будет использовать непосредственно в TenorFlow.</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>